# ADR-0001: CLI-First Architecture with Dual Model Routing and AskUser State Machine

## Status
Accepted

## Context
We are building a "Digital Clone" AI assistant system focused on MVP delivery with clear module boundaries. The system needs to support conversational AI with tool integration, complex task planning, and user clarification mechanisms.

Key requirements:
- CLI-first delivery for rapid iteration and testing
- Dual model routing (chat for simple tasks, reasoner for complex planning)
- Tool system with JSON Schema validation
- AskUser mechanism for clarification without deadlocks
- Conversation logging for future RAG integration

## Decision
We adopt a CLI-first architecture with the following components:

### 1. CLI-First Approach
- Primary interface is command-line REPL
- Enables rapid development cycles without UI complexity
- Allows easy testing of all core features
- Future UI (Gradio/React) will be built on top of this core

### 2. Dual Model Routing Strategy
- **DeepSeek-chat**: Handles routine Q&A and simple tool calls
- **DeepSeek-reasoner**: Activated only for complex tasks requiring planning/decomposition
- **Routing heuristics**:
  - Keyword detection (计划/规划/分解/多步骤/调研/写方案/评估/对比/流程/依赖/里程碑)
  - Structural patterns (numbered lists, flow arrows)
  - Length thresholds (>80 Chinese characters)
  - Explicit user requests for complexity
- **Fallback mechanism**: When uncertain, query reasoner for binary decision

### 3. AskUser State Machine
- **Problem**: Previous implementations suffered from deadlocks and lost context
- **Solution**: Explicit state machine with `awaiting_user_input` flag
- **Protocol**:
  - Model returns `role="ask_user"` messages with clarification questions
  - CLI enters waiting state, accepts only user input
  - Input is appended as new user message, state resets
  - Limits: Max 2 AskUser cycles per conversation turn

### 4. Tool Registration System
- **Dynamic discovery**: Scan `tools/` directory at startup
- **Standardization**: Each tool provides `TOOL_META` (JSON Schema) and `run(**kwargs)` function
- **Execution**: Unified interface with `ok/value/error` return structure
- **Safety**: Tools handle timeouts, exceptions, return human-readable errors

### 5. Message Protocol
- **Roles**: `user | assistant | tool | system | ask_user`
- **Structure**: Consistent message format across all components
- **Function calling**: Support both native function_call and fallback text patterns

## Consequences

### Positive
- **Rapid iteration**: CLI allows quick feature testing and validation
- **Clear separation**: Each component has well-defined interfaces
- **Extensibility**: Easy to add new tools, models, or UI layers
- **Reliability**: State machine prevents deadlocks in user interaction
- **Future-proofing**: Logging structure supports RAG integration

### Negative
- **UX limitations**: CLI interface may be less intuitive for end users
- **Testing complexity**: State machine requires careful testing of edge cases
- **Routing accuracy**: Heuristic-based routing may have false positives/negatives

### Mitigation Strategies
- **UX**: Plan Gradio UI for user-friendly interface in next iteration
- **Testing**: Comprehensive unit tests for all state transitions
- **Routing**: Monitor routing accuracy and refine heuristics based on logs

## Alternatives Considered

### Single Model Approach
- **Rejected**: Would require complex prompting to handle both simple and complex tasks
- **Drawback**: Higher latency and token costs for simple interactions

### Web-first Architecture
- **Rejected**: UI development would slow initial feature validation
- **Drawback**: Harder to test core logic independently

### Synchronous AskUser (blocking)
- **Rejected**: Previous implementations showed deadlock issues
- **Drawback**: Poor user experience with unclear waiting states

## Implementation Notes
- All configurations centralized in `config.py` with `.env` support
- Logging uses JSONL format for easy parsing and future vectorization
- Tool schemas validated at registration time
- Mock client enables development without API keys
